<!DOCTYPE html>
<html lang="en">
<head>
<meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no, user-scalable=no" />
<meta charset="UTF-8" />
<link href="/bootstrap.css" rel="stylesheet" />
<script type="text/javascript" src="speedtest-cf.js"></script>
<script type="text/javascript">
function I(i){return document.getElementById(i);}
var base = window.location.origin + '/';
var s = new CFSpeedtest(base);

/* Bootstrap 5 native colors (for canvas; classes used elsewhere) */
var meterBk="#dee2e6";
var activeColor="#0d6efd";
var pausedColor="#6c757d";
var progColor="#dee2e6";

function drawMeter(c,amount,bk,fg,progress,prog){
	var ctx=c.getContext("2d");
	var dp=window.devicePixelRatio||1;
	var cw=c.clientWidth*dp, ch=c.clientHeight*dp;
	var sizScale=ch*0.0055;
	if(c.width==cw&&c.height==ch){ ctx.clearRect(0,0,cw,ch); }
	else { c.width=cw; c.height=ch; }
	ctx.beginPath();
	ctx.strokeStyle=bk;
	ctx.lineWidth=12*sizScale;
	ctx.arc(c.width/2,c.height-58*sizScale,c.height/1.8-ctx.lineWidth,-Math.PI*1.1,Math.PI*0.1);
	ctx.stroke();
	ctx.beginPath();
	ctx.strokeStyle=fg;
	ctx.lineWidth=12*sizScale;
	ctx.arc(c.width/2,c.height-58*sizScale,c.height/1.8-ctx.lineWidth,-Math.PI*1.1,amount*Math.PI*1.2-Math.PI*1.1);
	ctx.stroke();
	if(typeof progress !== "undefined"){
		ctx.fillStyle=prog;
		var barW=c.width*0.4*progress;
		ctx.fillRect((c.width-barW)/2,c.height-16*sizScale,barW,4*sizScale);
	}
}
function mbpsToAmount(s){ return 1-(1/(Math.pow(1.3,Math.sqrt(s)))); }
function format(d){
	d=Number(d);
	if(d<10) return d.toFixed(2);
	if(d<100) return d.toFixed(1);
	return d.toFixed(0);
}

var uiData=null;
var testComplete=false;
var lastDl=0, lastUl=0;
function startStop(){
	if(s.getState()==3){
		s.abort();
		uiData=null;
		testComplete=false;
		lastDl=0; lastUl=0;
		I("startStopBtn").className="btn btn-primary";
		I("startStopBtn").textContent="Start";
		I("statusMsg").textContent="";
		I("statusMsg").className="";
		initUI();
	} else {
		testComplete=false;
		lastDl=0; lastUl=0;
		I("startStopBtn").className="btn btn-danger";
		I("startStopBtn").textContent="Abort";
		I("statusMsg").textContent="";
		I("statusMsg").className="";
		s.onupdate=function(data){ uiData=data; };
		s.onend=function(aborted){
			updateUI(true);
			if(aborted){
				I("startStopBtn").className="btn btn-primary";
				I("startStopBtn").textContent="Start";
				I("statusMsg").textContent="";
			} else {
				testComplete=true;
				I("startStopBtn").className="btn btn-success";
				I("startStopBtn").textContent="Done";
				I("statusMsg").textContent="Test complete.";
				I("statusMsg").className="text-success fw-bold";
			}
		};
		s.start();
	}
}
function updateUI(forced){
	if(!forced&&s.getState()!=3) return;
	if(uiData==null) return;
	var status=uiData.testState;
	if(status>=1&&uiData.dlStatus!==''){ var v=Number(uiData.dlStatus); if(!isNaN(v)) lastDl=v; }
	if(status>=3&&uiData.ulStatus!==''){ var v=Number(uiData.ulStatus); if(!isNaN(v)) lastUl=v; }
	if(uiData.clientIp!=='') I("ip").textContent=uiData.clientIp;
	if(uiData.colo!=='') document.getElementById('colo').textContent=uiData.colo;
	var dlActive=status===1, ulActive=status===3;
	var dlVal=dlActive?Number(uiData.dlStatus)*(oscillate()):lastDl;
	var ulVal=ulActive?Number(uiData.ulStatus)*(oscillate()):lastUl;
	var dlProg=Number(uiData.dlProgress), ulProg=Number(uiData.ulProgress);
	if(status!==1&&lastDl>0) dlProg=1;
	if(status!==3&&lastUl>0) ulProg=1;
	I("dlText").textContent=dlActive&&(uiData.dlStatus===''||Number(uiData.dlStatus)===0)?"...":format(dlActive?uiData.dlStatus:lastDl);
	I("ulText").textContent=ulActive&&(uiData.ulStatus===''||Number(uiData.ulStatus)===0)?"...":format(ulActive?uiData.ulStatus:lastUl);
	drawMeter(I("dlMeter"),mbpsToAmount(dlVal),meterBk,dlActive?activeColor:pausedColor,dlProg,progColor);
	drawMeter(I("ulMeter"),mbpsToAmount(ulVal),meterBk,ulActive?activeColor:pausedColor,ulProg,progColor);
	if(uiData.pingStatus!=='') I("pingText").textContent=format(uiData.pingStatus);
	if(uiData.jitterStatus!=='') I("jitText").textContent=format(uiData.jitterStatus);
}
function oscillate(){ return 1+0.02*Math.sin(Date.now()/100); }
window.requestAnimationFrame=window.requestAnimationFrame||window.webkitRequestAnimationFrame||window.mozRequestAnimationFrame||window.msRequestAnimationFrame||function(cb){setTimeout(cb,1000/60);};
function frame(){ requestAnimationFrame(frame); updateUI(); }
frame();
function initUI(){
	lastDl=0; lastUl=0;
	drawMeter(I("dlMeter"),0,meterBk,pausedColor,0);
	drawMeter(I("ulMeter"),0,meterBk,pausedColor,0);
	I("pingText").textContent="0.00";
	I("jitText").textContent="0.00";
	I("dlText").textContent="0";
	I("ulText").textContent="0";
	I("ip").textContent="—";
	document.getElementById('colo').textContent="CF: —";
	I("statusMsg").textContent="";
	I("statusMsg").className="";
}
</script>
<style type="text/css">
#startStopBtn{min-width:7rem;height:3rem;display:inline-flex;align-items:center;justify-content:center;}
#statusMsg{min-height:1.5em;}
.testArea{display:inline-block;width:16em;height:12.5em;position:relative;box-sizing:border-box;text-align:center;}
.testArea2{display:inline-block;width:14em;height:7em;position:relative;text-align:center;}
.testArea .testName{position:absolute;top:0.1em;left:0;width:100%;font-size:1.1rem;z-index:9;text-align:center;}
.testArea2 .testName{display:block;text-align:center;font-size:1.1rem;}
.testArea .meterText{position:absolute;bottom:1.55em;left:0;width:100%;font-size:2rem;z-index:9;text-align:center;}
.testArea2 .meterText{display:inline-block;font-size:2rem;}
.testArea .unit{position:absolute;bottom:2em;left:0;width:100%;font-size:0.9rem;z-index:9;text-align:center;}
.testArea canvas{position:absolute;top:0;left:0;width:100%;height:100%;z-index:1;}
</style>
<title>Speedtest</title>
</head>
<body class="bg-light">
<div class="container py-4">
	<div class="text-center mb-4">
		<h1 class="h2 mb-3">Speedtest</h1>
		<button type="button" id="startStopBtn" class="btn btn-primary btn-lg px-4" onclick="startStop()">Start</button>
		<div id="statusMsg" class="mt-2" aria-live="polite"></div>
	</div>
	<div id="test" class="card shadow-sm mx-auto" style="max-width:42rem;">
		<div class="card-body p-4">
			<div class="row g-3 justify-content-center mb-3">
				<div class="col-auto testArea2"><div class="testName text-muted">Ping</div><div id="pingText" class="meterText text-dark">0.00</div><div class="unit text-muted">ms</div></div>
				<div class="col-auto testArea2"><div class="testName text-muted">Jitter</div><div id="jitText" class="meterText text-dark">0.00</div><div class="unit text-muted">ms</div></div>
			</div>
			<div class="row g-3 justify-content-center">
				<div class="col-auto testArea"><div class="testName text-muted">Download</div><canvas id="dlMeter" class="meter"></canvas><div id="dlText" class="meterText">0</div><div class="unit text-muted">Mbps</div></div>
				<div class="col-auto testArea"><div class="testName text-muted">Upload</div><canvas id="ulMeter" class="meter"></canvas><div id="ulText" class="meterText">0</div><div class="unit text-muted">Mbps</div></div>
			</div>
			<div class="mt-3 text-center">
				<small id="colo" class="text-muted d-block">CF: —</small>
				<small id="ip" class="text-muted d-block">—</small>
			</div>
		</div>
	</div>
</div>
<script>setTimeout(initUI,100);</script>
</body>
</html>
