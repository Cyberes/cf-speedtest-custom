#!/usr/bin/env node
/**
 * Reads public/*.html and public/*.js and generates src/assets.js with exported string constants.
 */
const fs = require('fs');
const path = require('path');

const ROOT = path.resolve(__dirname);
const PUBLIC = path.join(ROOT, 'public');
const OUT = path.join(ROOT, 'src', 'assets.js');
const BOOTSTRAP_CSS_PATH = path.join(ROOT, 'node_modules', 'bootstrap', 'dist', 'css', 'bootstrap.min.css');

function escapeJs(str) {
  return str
    .replace(/\\/g, '\\\\')
    .replace(/`/g, '\\`')
    .replace(/\$/g, '\\$')
    .replace(/\r\n/g, '\n')
    .replace(/\r/g, '\n');
}

const files = [
  { file: 'index.html', export: 'INDEX_HTML' },
  { file: 'speedtest-cf.js', export: 'SPEEDTEST_CF_JS' },
];

const lines = ['// Auto-generated by bundle-assets.js - do not edit', ''];

for (const { file, export: exp } of files) {
  const p = path.join(PUBLIC, file);
  let content = '';
  if (fs.existsSync(p)) {
    content = fs.readFileSync(p, 'utf8');
  }
  const escaped = escapeJs(content);
  lines.push(`export const ${exp} = \`${escaped}\`;`);
  lines.push('');
}

if (fs.existsSync(BOOTSTRAP_CSS_PATH)) {
  const bootstrapCss = fs.readFileSync(BOOTSTRAP_CSS_PATH, 'utf8');
  const escaped = escapeJs(bootstrapCss);
  lines.push(`export const BOOTSTRAP_CSS = \`${escaped}\`;`);
} else {
  lines.push("export const BOOTSTRAP_CSS = '';");
}
lines.push('');

fs.mkdirSync(path.dirname(OUT), { recursive: true });
fs.writeFileSync(OUT, lines.join('\n'), 'utf8');
console.log('Wrote', OUT);
